/**
 * Solana BPF zkVM - Browser Interface
 * 
 * Loads the WASM module and provides UI for proof generation.
 */

// Import the WASM module (generated by wasm-pack)
import init, { 
    prove_counter, 
    verify_counter_proof,
    get_prover_info 
} from './pkg/wasm_prover.js';

// State
let wasmReady = false;
let currentProof = null;
let currentInitialValue = null;

// DOM Elements
const proveBtn = document.getElementById('proveBtn');
const verifyBtn = document.getElementById('verifyBtn');
const initialValueInput = document.getElementById('initialValue');
const statusDiv = document.getElementById('status');
const statusText = document.getElementById('statusText');
const resultsDiv = document.getElementById('results');
const proofSizeSpan = document.getElementById('proofSize');
const provingTimeSpan = document.getElementById('provingTime');
const instructionCountSpan = document.getElementById('instructionCount');
const verificationStatusSpan = document.getElementById('verificationStatus');
const proofHexTextarea = document.getElementById('proofHex');
const copyBtn = document.getElementById('copyBtn');

/**
 * Show status message
 */
function showStatus(message, type = 'loading') {
    statusDiv.style.display = 'flex';
    statusDiv.className = `status ${type}`;
    statusText.textContent = message;
    
    // Show/hide spinner based on type
    const spinner = statusDiv.querySelector('.spinner');
    if (spinner) {
        spinner.style.display = type === 'loading' ? 'block' : 'none';
    }
}

/**
 * Hide status
 */
function hideStatus() {
    statusDiv.style.display = 'none';
}

/**
 * Convert Uint8Array to hex string
 */
function toHex(bytes) {
    return Array.from(bytes)
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
}

/**
 * Format bytes as human-readable size
 */
function formatBytes(bytes) {
    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)} KB`;
    return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
}

/**
 * Initialize WASM module
 */
async function initWasm() {
    showStatus('Loading WASM module...', 'loading');
    
    try {
        await init();
        wasmReady = true;
        
        // Log prover info
        const info = JSON.parse(get_prover_info());
        console.log('zkVM Prover initialized:', info);
        
        showStatus('WASM module ready', 'success');
        setTimeout(hideStatus, 2000);
        
        proveBtn.disabled = false;
    } catch (error) {
        console.error('Failed to initialize WASM:', error);
        showStatus(`Failed to load WASM: ${error.message}`, 'error');
        proveBtn.disabled = true;
    }
}

/**
 * Generate proof
 */
async function generateProof() {
    if (!wasmReady) {
        showStatus('WASM not ready', 'error');
        return;
    }
    
    const initialValue = BigInt(initialValueInput.value || '0');
    
    proveBtn.disabled = true;
    verifyBtn.disabled = true;
    resultsDiv.classList.remove('visible');
    
    showStatus('Executing counter program...', 'loading');
    
    try {
        const startTime = performance.now();
        
        // This runs entirely in WASM - no data leaves the browser
        showStatus('Generating zero-knowledge proof...', 'loading');
        const proof = await prove_counter(initialValue);
        
        const endTime = performance.now();
        const provingTime = ((endTime - startTime) / 1000).toFixed(2);
        
        currentProof = proof;
        currentInitialValue = initialValue;
        
        // Update results
        proofSizeSpan.textContent = formatBytes(proof.length);
        provingTimeSpan.textContent = `${provingTime}s`;
        instructionCountSpan.textContent = '5'; // Hardcoded for counter program
        verificationStatusSpan.textContent = 'Pending';
        proofHexTextarea.value = toHex(proof);
        
        resultsDiv.classList.add('visible');
        verifyBtn.disabled = false;
        
        showStatus('Proof generated successfully!', 'success');
        setTimeout(hideStatus, 3000);
        
        console.log('Proof generated:', {
            size: proof.length,
            time: provingTime,
            initialValue: initialValue.toString()
        });
        
    } catch (error) {
        console.error('Proof generation failed:', error);
        showStatus(`Proof generation failed: ${error.message}`, 'error');
    } finally {
        proveBtn.disabled = false;
    }
}

/**
 * Verify current proof
 */
async function verifyProof() {
    if (!currentProof) {
        showStatus('No proof to verify', 'error');
        return;
    }
    
    verifyBtn.disabled = true;
    showStatus('Verifying proof...', 'loading');
    
    try {
        const finalValue = currentInitialValue + 1n;
        
        const valid = await verify_counter_proof(
            currentProof,
            currentInitialValue,
            finalValue
        );
        
        if (valid) {
            verificationStatusSpan.textContent = '✓ Valid';
            verificationStatusSpan.style.color = 'var(--success)';
            showStatus('Proof verified successfully!', 'success');
        } else {
            verificationStatusSpan.textContent = '✗ Invalid';
            verificationStatusSpan.style.color = 'var(--error)';
            showStatus('Proof verification failed', 'error');
        }
        
        setTimeout(hideStatus, 3000);
        
    } catch (error) {
        console.error('Verification failed:', error);
        verificationStatusSpan.textContent = `Error: ${error.message}`;
        showStatus(`Verification error: ${error.message}`, 'error');
    } finally {
        verifyBtn.disabled = false;
    }
}

/**
 * Copy proof to clipboard
 */
async function copyProof() {
    const hex = proofHexTextarea.value;
    if (!hex) return;
    
    try {
        await navigator.clipboard.writeText(hex);
        copyBtn.textContent = 'Copied!';
        setTimeout(() => {
            copyBtn.textContent = 'Copy to Clipboard';
        }, 2000);
    } catch (error) {
        console.error('Failed to copy:', error);
    }
}

// Event listeners
proveBtn.addEventListener('click', generateProof);
verifyBtn.addEventListener('click', verifyProof);
copyBtn.addEventListener('click', copyProof);

// Initialize on load
initWasm();

